<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />
		<link rel="stylesheet" href="vendor/waves/waves.min.css" />
		<link rel="stylesheet" href="vendor/wow/animate.css" />
		<link rel="stylesheet" href="css/nativedroid2.css" />

		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>

		<div data-role="page">

			<div data-role="header" data-position="fixed" class="wow fadeInDown" data-wow-delay="0.2s">
				<a href="#bottomsheet" class="ui-btn ui-btn-right wow fadeIn" data-wow-delay='1.2s'><i class="zmdi zmdi-more-vert"></i></a>
				<a href="#leftpanel" class="ui-btn ui-btn-left wow fadeIn" data-wow-delay='0.8s'><i class="zmdi zmdi-menu"></i></a>
				<h1 class="wow fadeIn" data-wow-delay='0.4s'>Page Title</h1>
			</div>

			<div role="main" class="ui-content" data-inset="false">
				<svg id="graph" width="400" height="600"></svg>
			</div>
			<div>
				<div id="maxyaw"><span class="l">Max Yaw: </span><span class="v"></span> [<span class="d"></span>]</div>
				<div id="maxtilt"><span class="l">Max Tilt: </span><span class="v"></span> [<span class="d"></span>]</div>
			</div>
			<div id="log" />
		</div>
		<style>
			/* tell the SVG path to be a thin blue line without any area fill */
			path {
				stroke-width: 1;
				fill: none;
			}
			
			.data1 {
				stroke: steelblue;
			}

			.data2 {
				stroke: orange;
			}

			.data3 {
				stroke: green;
			}

			.axis {
			  shape-rendering: crispEdges;
			}

			.x.axis line {
			  stroke: lightgrey;
			}

			.x.axis .minor {
			  stroke-opacity: .5;
			}

			.x.axis path {
			  display: none;
			}
			
			.x.axis text {
				font-size: 14;
			}

			.y.axis line, .y.axis path {
			  fill: none;
			  stroke: #000;
			}

			.y.axis text {
				font-size: 14;
			}

			.y.axisRight text {
				fill: orange;
			}
			
			.y.axisLeft text {
				fill: steelblue;
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
		<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>
		<script src="https://d3js.org/d3.v3.min.js"></script>

		<script>
    $(document).bind('mobileinit',function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });


var lineData = [];
var data1 = [];
var data2 = [];
var data3 = [];

function mkGraph()
{
	/* implementation heavily influenced by http://bl.ocks.org/1166403 */
		/* some arguments AGAINST the use of dual-scaled axes line graphs can be found at http://www.perceptualedge.com/articles/visual_business_intelligence/dual-scaled_axes.pdf */
		
		// define dimensions of graph
		var m = [80, 80, 80, 80]; // margins
		var w = 400 - m[1] - m[3];	// width
		var h = 600 - m[0] - m[2]; // height

		var x = d3.scale.linear().domain([0, data1.length]).range([0, w]);
		var y1 = d3.scale.linear().domain([-50, 50]).range([h, 0]); 
		var y2 = d3.scale.linear().domain([-180, 180]).range([h, 0]);  
			
		// create a line function that can convert data[] into x and y points
		var line1 = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d) { return y1(d); });
			
		
		// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select("#graph").append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

		// create yAxis
		var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
		// Add the x-axis.
		graph.append("svg:g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + h + ")")
		      .call(xAxis);

		// create left yAxis
		var yAxisLeft = d3.svg.axis().scale(y1).ticks(4).orient("left");
		// Add the y-axis to the left
		graph.append("svg:g")
		      .attr("class", "y axis axisLeft")
		      .attr("transform", "translate(-15,0)")
		      .call(yAxisLeft);

		// add lines
		// do this AFTER the axes above so that the line is above the tick-lines
		graph.append("svg:path").attr("d", line1(data3)).attr("class", "data3");
		graph.append("svg:path").attr("d", line1(data1)).attr("class", "data1");
		graph.append("svg:path").attr("d", line1(data2)).attr("class", "data2");

		console.log("##1: " + JSON.stringify(data1));
		console.log("##2: " + JSON.stringify(data2));
		console.log("##3: " + JSON.stringify(data3));
}

var maxTilt = { v: 0, d: null };
var maxYaw = { v: 0, d: null };

function setMax(key, maxV, v, d) {
	if (Math.abs(v) > maxV.v) { 
		maxV.v = Math.abs(v); 
		maxV.d=d;
		$(key + ' span.v').text(maxV.v);
    	$(key + ' span.d').text(maxV.d);
    }
}

function deviceOrientationListener(event) {
	 var m = {};
     m.dir=event.alpha;
     m.tilt=event.beta;
     m.yaw=event.gamma;
     m.count = lineData.length;
     lineData.push(m);
     data1.push(m.tilt);
     data2.push(m.yaw);
     data3.push(m.dir);

     setMax("#maxyaw", maxYaw, m.yaw, m.dir);
     setMax("#maxtilt", maxTilt, m.tilt, m.dir);
     console.log("## "+m.tilt + ",   "+m.yaw+",   "+m.dir);

     if (m.count==100)
     {
		window.removeEventListener("deviceorientation", deviceOrientationListener);
        mkGraph();
        return;
     }
     //$("#log").append("<p>Event: D="+dir+", T="+tilt+", Y="+yaw+"</p>");
}

if (window.DeviceOrientationEvent) {
   window.addEventListener("deviceorientation", deviceOrientationListener);
}
else {
    alert("Sorry, your browser doesn't support Device Orientation");
}


</script> 

	</body>
</html>
