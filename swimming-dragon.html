<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


		<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />-->
		<!--<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />-->
		<!--<link rel="stylesheet" href="css/nativedroid2.css" />-->
		<!--<link rel="stylesheet" href="vendor/waves/waves.min.css" />-->
		<!--<link rel="stylesheet" href="vendor/wow/animate.css" />-->
    	<link rel="stylesheet" type="text/css" href="css/swimming-dragon.css">
    	<link rel="stylesheet" type="text/css" href="css/table.css">

		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>
		<div>
			<div role="main">
				<div id="buttons" style="display: none;">
					<a href="#" id="switch-polar" class="scb"><img src="img/Polar1.png"/></a>
					<a href="#" id="switch-linear"class="scb"><img src="img/Linear.png"/></a>
					<a href="#" id="switch-beta" class="scb"><img src="img/UpDown.png"/></a>
					<a href="#" id="switch-gamma" class="scb"><img src="img/LeftRight.png"/></a>
					<a href="#" id="switch-stats" class="scb"><img src="img/Summary.png"/></a>
					<a href="#" id="restart" class="scb"><img src="img/Restart.png"/></a>
				</div>
				<div id="working">
					<svg xmlns="http://www.w3.org/2000/svg" height="256" width="256" viewBox="-8 -8 16 16">
						<circle r="7" fill="#808080" filter="url(#f)"/>
						<path d="m0-7a3.5 3.5 0 1 1 0 7 3.5 3.5 0 1 0 0 7 7 7 0 1 1 0-14z" fill="#ccf"/>
						<path d="m0-7a7 7 0 1 1 0 14 3.5 3.5 0 1 1 0-7 3.5 3.5 0 1 0 0-7z" fill="#004"/>
						<circle cy="-3.5" r="1.1" fill="#004"/>
						<circle cy="3.5" r="1.1" fill="#ccf"/>
						</g>
					</svg>
				</div>
				<div id="graphs" style="display: none;">
				</div>
				<div id="stats" style="display: none;">
					<table class="stats" id="gradient-style">
						<tr><th>Stats</th><th>Beta</th><th>Gamma</th></tr>
						<tr class="min"><td><strong>Min</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="max"><td><strong>Max</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="avg"><td><strong>Avg</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="aavg"><td><strong>Abs Avg</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="sd"><td><strong>Std. Dev</strong></td><td class="b"></td><td class="g"></tr>
					</table>
					<p>For a summary of beta and gamma, please look <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Orientation_and_motion_data_explained">here</a></p>
				</div>
			</div>
		</div>
		<style>
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!--<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>-->
		<!--<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>-->
		<!--<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>-->
		<script src="js/d3.v3.min.js"></script>
		<script src="js/yin-yang.js"></script>
		<script src="howler2.js"></script>
		<script src="NoSleep.js"></script>

		<script>
var second= 1000;
var speed= 3*second;
var graph = null;
var data = [];
var statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var sound = new Audio("music/ting.wav");
var chartType="linear";
var chartData="stats";
var pointMappers = {}
var linetype="linear";
var testMode="NONE";
function drawLine(graph, cls, data, fX, aX, fY, aY, colour, opacity)
{
	var line = d3.svg.line()
			.interpolate(linetype)
			.x(function(d) { return fX(d[aX]); })
			.y(function(d) { return fY(d[aY]); });

	graph.append("svg:path")
		.attr("d", line(data))
		.attr("class", cls)
		.attr('stroke', colour)
		.attr('stroke-width', 1)
		.attr('fill', 'none')
	    .attr('stroke-opacity', opacity);
}

function transitionLine(cls, data, fX, aX, fY, aY)
{
	var line = d3.svg.line()
			.interpolate(linetype)
			.x(function(d) { return fX(d[aX]); })
			.y(function(d) { return fY(d[aY]); });

	graph.selectAll("path."+cls).transition().duration(speed).attr("d", line(data));
}

function transitionPolar(cls, data, fX, aX, fR, aR)
{
	var polar = function(d) {
    	var r=fR(d[aR]);
    	var t=(d[aX]%360)/360*(Math.PI*2);
   		var p = { x: r*Math.cos(t)+170, y: r*Math.sin(t)+170 };
    	return p;
  	}

  	var line = d3.svg.line()
  		.interpolate(linetype)
  		.x(function(d) { return polar(d).x; })
  		.y(function(d) { return polar(d).y; });


	graph.selectAll('path.'+cls).transition().duration(speed).attr("d", line(data));
}

function drawDots(graph, cls, data, fX, aX, fY, aY, colour, opacity)
{
	graph.selectAll("dot")
	   	.data(data)
	    .enter().append("circle")
		.attr("class", cls)
		.attr('stroke', colour)
	    .attr("r", 0.7)
	    .attr("cx", function(d) { return fX(d[aX]); })
	    .attr("cy", function(d) { return fY(d[aY]); })
	    .attr('opacity', opacity);
}


function populateGraph(graph)
{	
	var h=170; //graph.attr('height')/2;
	var w=340; //graph.attr('width');
	var mxB = d3.max(data, function (d) { return d.b; });
	var mnB = d3.min(data, function (d) { return d.b; }); 
	var rangeB = Math.max(mxB, -1*mnB);
	var mxG = d3.max(data, function (d) { return d.g; });
	var mnG = d3.min(data, function (d) { return d.g; }); 
	var rangeG = Math.max(mxG, -1*mnG);

	for (var i=0; i<data.length; i++)
	{
		data[i].z=0;
		data[i].mxB=rangeB;
		data[i].mnB=rangeB*-1;
		data[i].mxA=-180;
		data[i].mnA=180;
		data[i].mxG=rangeG;
		data[i].mnG=rangeG*-1;
	}

	rangeB *= 1.1;
	rangeG *= 1.1;
	pointMappers.x   = d3.scale.linear().domain([0, data.length]).range([0, w]);
	pointMappers.yB  = d3.scale.linear().domain([ -1*rangeB,  rangeB]).range([h, 0]);
	pointMappers.rB  = d3.scale.linear().domain([ -1*rangeB,  rangeB]).range([170, 90]);
	pointMappers.yG  = d3.scale.linear().domain([ -1*rangeG,  rangeG]).range([h, 0]); 
	pointMappers.rG  = d3.scale.linear().domain([ -1*rangeG,  rangeG]).range([170, 90]); 
	pointMappers.yA  = d3.scale.linear().domain([ -185,  185]).range([2*h, h]); 

	var x=pointMappers.x;
	var y=pointMappers.yB;
	drawLine(graph, "beta beta-data", data, x, "n", y, "b",   "orange", 1.0);
	drawLine(graph, "beta beta-mx ",   data, x, "n", y, "mxB", "#666666", 1.0);
	drawLine(graph, "beta beta-z",    data, x, "n", y, "z",   "#666666", 1.0);
	drawLine(graph, "beta beta-mn",   data, x, "n", y, "mnB", "#666666", 1.0);

	x=pointMappers.x;
	y=pointMappers.yG;
	drawLine(graph, "gamma gamma-data",    data, x, "n", y, "g",   "green", 0.0);
	drawLine(graph, "gamma gamma-mx", data, x, "n", y, "mxG", "#666666", 0.0);
	drawLine(graph, "gamma gamma-z",  data, x, "n", y, "z",   "#666666", 0.0);
	drawLine(graph, "gamma gamma-mn", data, x, "n", y, "mnG", "#666666", 0.0);

	x=pointMappers.x;
	y=pointMappers.yA;
	drawDots(graph, "alpha alpha-data", data, x, "n", y, "a", "purple", 1.0)
	drawLine(graph, "alpha alpha-mx", data, x, "n", y, "mxA", "#666666", 1.0);
	drawLine(graph, "alpha alpha-z",  data, x, "n", y, "z",   "#666666", 1.0);
	drawLine(graph, "alpha alpha-mn", data, x, "n", y, "mnA", "#666666", 1.0);
}

function switchToGamma()
{
	$('#stats').hide();
	$('#graphs').show();
	$('#switch-beta').show();
	$('#switch-gamma').hide();
	if (chartData=="gamma") return;
	chartData="gamma";
	if (chartData=="beta")
	{
		$('#switch-gamma').show();
		$('#switch-beta').hide();
	} else {

		$('#switch-gamma').hide();
		$('#switch-beta').show();
	}
	graph.selectAll('path.beta').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('path.gamma').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	var alphaOpacity = (chartType=="polar") ? 0.0 : 1.0;
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", alphaOpacity);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", alphaOpacity);
}

function switchToBeta()
{
	$('#stats').hide();
	$('#graphs').show();
	$('#switch-beta').hide();
	$('#switch-gamma').show();
	if (chartData=="beta") return;
	chartData="beta";
	if (chartData!="gamma")
	{
		$('#switch-gamma').show();
		$('#switch-beta').hide();
	} else {

		$('#switch-gamma').hide();
		$('#switch-beta').show();
	}
	graph.selectAll('path.beta').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('path.gamma').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	var alphaOpacity = (chartType=="polar") ? 0.0 : 1.0;
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", alphaOpacity);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", alphaOpacity);
}

function switchToPolar()
{
	$('#stats').hide();
	$('#graphs').show();
	$('#switch-polar').hide();
	$('#switch-linear').show();
	$('#switch-stats').show();
	if (chartData!="gamma")
	{
		$('#switch-gamma').show();
		$('#switch-beta').hide();
	} else {

		$('#switch-gamma').hide();
		$('#switch-beta').show();
	}
	if (chartType=="polar") return;
	chartType="polar";
	var x=pointMappers.x;
	var y=pointMappers.rB;
	transitionPolar("beta-data", data, x, "a", y, "b");
	transitionPolar("beta-mx",   data, x, "a", y, "mxB");
	transitionPolar("beta-z",    data, x, "a", y, "z");
	transitionPolar("beta-mn",   data, x, "a", y, "mnB");

	x=pointMappers.x;
	y=pointMappers.rG;
	transitionPolar("gamma-data",    data, x, "a", y, "g");
	transitionPolar("gamma-mx", data, x, "a", y, "mxG");
	transitionPolar("gamma-z",  data, x, "a", y, "z");
	transitionPolar("gamma-mn", data, x, "a", y, "mnG");

	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", 0.0);
}

function switchToLinear()
{
	$('#stats').hide();
	$('#graphs').show();
	$('#switch-polar').show();
	$('#switch-linear').hide();
	$('#switch-stats').show();
	if (chartData!="gamma")
	{
		$('#switch-gamma').show();
		$('#switch-beta').hide();
	} else {

		$('#switch-gamma').hide();
		$('#switch-beta').show();
	}
	if (chartType=="linear") return;
	chartType="linear";

	var x=pointMappers.x;
	var y=pointMappers.yB;
	transitionLine("beta-data", data, x, "n", y, "b");
	transitionLine("beta-mx",   data, x, "n", y, "mxB");
	transitionLine("beta-z",    data, x, "n", y, "z");
	transitionLine("beta-mn",   data, x, "n", y, "mnB");

	x=pointMappers.x;
	y=pointMappers.yG;
	transitionLine("gamma-data",  data, x, "n", y, "g");
	transitionLine("gamma-mx",    data, x, "n", y, "mxG");
	transitionLine("gamma-z",     data, x, "n", y, "z");
	transitionLine("gamma-mn",    data, x, "n", y, "mnG");

	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", 1.0);
}

function switchToStats()
{
	$('#stats').show();
	$('#graphs').hide();

	$('#switch-gamma').hide();
	$('#switch-beta').hide();
	
	$('#switch-polar').show();
	$('#switch-linear').show();
	$('#switch-stats').hide();
	$('#switch-alpha').hide();
	$('#switch-beta').hide();
	if (chartData=="stats") return;
	chartData="stats";
}


function setStats(id1, id2, stats, v, alpha)
{
	if (v > stats.mx) { stats.mx=v; }
	if (v < stats.mn) { stats.mn=v; }
	stats.num++;
	stats.sum+=v;
	stats.ssum+=v*v;
	stats.asum+=Math.abs(v);
	stats.amx=Math.max(stats.mx, -1*stats.mn);
	$(id1 + ' div').text(Math.round(stats.amx));
	var ac=100;
	var av=(stats.sum/stats.num)
	var sd=Math.sqrt((stats.ssum/stats.num)-av*av);

	console.log("STATS("+id2+"): "+JSON.stringify(stats));

	$(".stats .min " + id2).text(stats.mn.toFixed(2));
	$(".stats .max " + id2).text(stats.mx.toFixed(2));
	$(".stats .avg " + id2).text(av.toFixed(2));
	$(".stats .sd " + id2).text(sd.toFixed(2));
	$(".stats .aavg " + id2).text((stats.asum/stats.num).toFixed(2));
}


function deviceOrientationListener(event) {
	 var alpha = (event.alpha > 180) ? event.alpha-360 : event.alpha;

     var count=data.length;
     var d = { a:alpha, b: event.beta, g:event.gamma, n: count };
     data.push(d);

     setStats("#gB", ".b", statsB, event.beta,  alpha);
     setStats("#gG", ".g", statsG, event.gamma, alpha);

}

function startListener() {
	console.log("START");
	sound.play();

	data = [];
	statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	chartType="linear";
	chartData="stats";
	
	$('#working').show();
	$('#working svg').css("webkitAnimationPlayState", "running");
	$('#stats').hide();
	$('#graphs').show();
	$('#buttons').hide();
	statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	if (testMode=="SIMPLE")
		for (var i=0;i<60; i++)
			deviceOrientationListener({alpha: (i*10)%360, beta: (i*7)%12-6, gamma: i%11});

	window.addEventListener("deviceorientation", deviceOrientationListener);
}

function stopListener() {
	console.log("STOP");
	$("#graphs").css("height", "690px")
	$("#graphs").css("width", "340px");
	$('#working').hide();
	$('#working svg').css("webkitAnimationPlayState", "paused");

	graph = d3.select("#graphs").append("svg:svg")
		.attr("id", "sd-vis")
		.attr("width", 340)
		.attr("height", 340)
		.append("svg:g");

	 graph.append("text")
	 	.attr("class", "gamma")
	 	.attr("x", 170)
    	.attr("y", 170)
    	.attr("dy", ".35em")
    	.attr('font-size', '4em')
    	.attr('fill', '#cccccc')
    	.attr('stroke', '#cccccc')
    	.style("text-anchor", "middle")
    	.text("");



	$('#stats').show();
	$('#graphs').hide();
	$('#buttons').show();
	switchToStats();

	populateGraph(graph);

	sound.play();
	window.removeEventListener("deviceorientation", deviceOrientationListener);
}

function prepareListener()
{
	testMode="SIMPLE";
	s=second;
	console.log("PREPARE");
	$("#sd-vis").remove();

	$('#stats').hide();
	$('#graphs').show();
	$('#buttons').hide();

	$('#working').hide();
	$('#working').fadeIn(5*s);
	$('#working svg').css("webkitAnimationPlayState", "paused");

	if (testMode!="NONE") s=10;
	
	window.setTimeout(
		function() { 
			startListener();
			window.setTimeout(function() { stopListener(); }, 20*s);
		}, 5*s);
}

$('#working').hide();
$('#stats').hide();
$('#graph').show();
$('#buttons').hide();
$(document).ready(function() {
	sound = new Howl({ src: ["music/ting.wav"], volume: 1.0});
	prepareListener();
});

$('#switch-linear').click(switchToLinear);
$('#switch-polar').click(switchToPolar);
$('#switch-beta').click(switchToBeta);
$('#switch-gamma').click(switchToGamma);
$('#switch-stats').click(switchToStats);
$('#restart').click(prepareListener);
</script> 

	</body>
</html>
