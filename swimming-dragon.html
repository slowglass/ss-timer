<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


		<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />-->
		<!--<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />-->
		<!--<link rel="stylesheet" href="css/nativedroid2.css" />-->
		<!--<link rel="stylesheet" href="vendor/waves/waves.min.css" />-->
		<!--<link rel="stylesheet" href="vendor/wow/animate.css" />-->
    	<link rel="stylesheet" type="text/css" href="css/swimming-dragon.css">
    	<link rel="stylesheet" type="text/css" href="css/table.css">

		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>
		<div>
			<div role="main">
				<div id="buttons">
					<a href="#" id="switch-polar" class="scb"><img src="img/P.png"/></a>
					<a href="#" id="switch-linear"class="scb"><img src="img/L.png"/></a>
					<a href="#" id="switch-tilt" class="scb"><img src="img/X.png"/></a>
					<a href="#" id="switch-roll" class="scb"><img src="img/Y.png"/></a>
					<a href="#" id="switch-stats" class="scb"><img src="img/S.png"/></a>
					<a href="#" id="restart" class="scb"><img src="img/Blank.png"/></a>
				</div>
				<div id="graphs"></div>
				<div id="stats">
					<table class="stats" id="gradient-style">
						<tr><th>Stats</th><th>Beta</th><th>Gamma</th></tr>
						<tr class="min"><td><strong>Min</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="max"><td><strong>Max</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="avg"><td><strong>Avg</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="aavg"><td><strong>Abs Avg</strong></td><td class="b"></td><td class="g"></tr>
						<tr class="sd"><td><strong>Std. Dev</strong></td><td class="b"></td><td class="g"></tr>
					</table>
					<p>For a summary of beta and gamma, please look <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Orientation_and_motion_data_explained">here</a></p>
				</div>
			</div>
		</div>
		<style>
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!--<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>-->
		<!--<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>-->
		<!--<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>-->
		<script src="https://d3js.org/d3.v3.min.js"></script>

		<script src="howler2.js"></script>
		<script src="NoSleep.js"></script>

		<script>
var speed= 3000;
var graph = null;
var data = [];
var statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var sound = new Audio("music/ting.wav");
var chartType="linear";
var chartData="stats";
var pointMappers = {}
var linetype="linear";

function drawLine(graph, cls, data, fX, aX, fY, aY, colour, opacity)
{
	var line = d3.svg.line()
			.interpolate(linetype)
			.x(function(d) { return fX(d[aX]); })
			.y(function(d) { return fY(d[aY]); });

	graph.append("svg:path")
		.attr("d", line(data))
		.attr("class", cls)
		.attr('stroke', colour)
		.attr('stroke-width', 1)
		.attr('fill', 'none')
	    .attr('stroke-opacity', opacity);
}

function transitionLine(cls, data, fX, aX, fY, aY)
{
	var line = d3.svg.line()
			.interpolate(linetype)
			.x(function(d) { return fX(d[aX]); })
			.y(function(d) { return fY(d[aY]); });

	graph.selectAll("path."+cls).transition().duration(speed).attr("d", line(data));
}

function transitionPolar(cls, data, fX, aX, fR, aR)
{
	var polar = function(d) {
    	var r=fR(d[aR]);
    	var t=(d[aX]%360)/360*(Math.PI*2);
   		var p = { x: r*Math.cos(t)+170, y: r*Math.sin(t)+170 };
    	return p;
  	}

  	var line = d3.svg.line()
  		.interpolate(linetype)
  		.x(function(d) { return polar(d).x; })
  		.y(function(d) { return polar(d).y; });


	graph.selectAll('path.'+cls).transition().duration(speed).attr("d", line(data));
}

function drawDots(graph, cls, data, fX, aX, fY, aY, colour, opacity)
{
	graph.selectAll("dot")
	   	.data(data)
	    .enter().append("circle")
		.attr("class", cls)
		.attr('stroke', colour)
	    .attr("r", 0.7)
	    .attr("cx", function(d) { return fX(d[aX]); })
	    .attr("cy", function(d) { return fY(d[aY]); })
	    .attr('opacity', opacity);
}


function populateGraph(graph)
{	
	var h=170; //graph.attr('height')/2;
	var w=340; //graph.attr('width');
	var mxB = d3.max(data, function (d) { return d.b; });
	var mnB = d3.min(data, function (d) { return d.b; }); 
	var rangeB = Math.max(mxB, -1*mnB)*1.1;
	var mxG = d3.max(data, function (d) { return d.b; });
	var mnG = d3.min(data, function (d) { return d.b; }); 
	var rangeG = Math.max(mxG, -1*mnG)*1.1;

	for (var i=0; i<data.length; i++)
	{
		data[i].z=0;
		data[i].mxB=mxB;
		data[i].mnB=mnB;;
		data[i].mxA=-180;
		data[i].mnA=180;
		data[i].mxG=mxG;
		data[i].mnG=mnG;
	}

	pointMappers.x   = d3.scale.linear().domain([0, data.length]).range([0, w]);
	pointMappers.yB  = d3.scale.linear().domain([ -1*rangeB,  rangeB]).range([h, 0]);
	pointMappers.rB  = d3.scale.linear().domain([ -1*rangeB,  rangeB]).range([170, 30]);
	pointMappers.yG  = d3.scale.linear().domain([ -1*rangeG,  rangeG]).range([h, 0]); 
	pointMappers.rG  = d3.scale.linear().domain([ -1*rangeG,  rangeG]).range([170, 30]); 
	pointMappers.yA  = d3.scale.linear().domain([ -185,  185]).range([2*h, h]); 

	var x=pointMappers.x;
	var y=pointMappers.yB;
	drawLine(graph, "beta beta-data", data, x, "n", y, "b",   "orange", 1.0);
	drawLine(graph, "beta beta-mx ",   data, x, "n", y, "mxB", "#666666", 1.0);
	drawLine(graph, "beta beta-z",    data, x, "n", y, "z",   "#666666", 1.0);
	drawLine(graph, "beta beta-mn",   data, x, "n", y, "mnB", "#666666", 1.0);

	x=pointMappers.x;
	y=pointMappers.yG;
	drawLine(graph, "gamma gamma-data",    data, x, "n", y, "g",   "green", 0.0);
	drawLine(graph, "gamma gamma-mx", data, x, "n", y, "mxG", "#666666", 0.0);
	drawLine(graph, "gamma gamma-z",  data, x, "n", y, "z",   "#666666", 0.0);
	drawLine(graph, "gamma gamma-mn", data, x, "n", y, "mnG", "#666666", 0.0);

	x=pointMappers.x;
	y=pointMappers.yA;
	drawDots(graph, "alpha alpha-data", data, x, "n", y, "a", "purple", 1.0)
	drawLine(graph, "alpha alpha-mx", data, x, "n", y, "mxA", "#666666", 1.0);
	drawLine(graph, "alpha alpha-z",  data, x, "n", y, "z",   "#666666", 1.0);
	drawLine(graph, "alpha alpha-mn", data, x, "n", y, "mnA", "#666666", 1.0);
}

function switchToRoll()
{
	$('#stats').hide();
	$('#graphs').show();
	if (chartData=="gamma") return;
	chartData="gamma";
	graph.selectAll('path.beta').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('path.gamma').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	var alphaOpacity = (chartType=="polar") ? 0.0 : 1.0;
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", alphaOpacity);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", alphaOpacity);
}

function switchToTilt()
{
	$('#stats').hide();
	$('#graphs').show();
	if (chartData=="beta") return;
	chartData="beta";
	graph.selectAll('path.beta').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('path.gamma').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	var alphaOpacity = (chartType=="polar") ? 0.0 : 1.0;
	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", alphaOpacity);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", alphaOpacity);
}

function switchToPolar()
{
	$('#stats').hide();
	$('#graphs').show();
	if (chartType=="polar") return;
	chartType="polar";
	var x=pointMappers.x;
	var y=pointMappers.rB;
	transitionPolar("beta-data", data, x, "a", y, "b");
	transitionPolar("beta-mx",   data, x, "a", y, "mxB");
	transitionPolar("beta-z",    data, x, "a", y, "z");
	transitionPolar("beta-mn",   data, x, "a", y, "mnB");

	x=pointMappers.x;
	y=pointMappers.rG;
	transitionPolar("gamma-data",    data, x, "a", y, "g");
	transitionPolar("gamma-mx", data, x, "a", y, "mxG");
	transitionPolar("gamma-z",  data, x, "a", y, "z");
	transitionPolar("gamma-mn", data, x, "a", y, "mnG");

	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 0.0);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", 0.0);
}

function switchToLinear()
{
	$('#stats').hide();
	$('#graphs').show();
	if (chartType=="linear") return;
	chartType="linear";

	var x=pointMappers.x;
	var y=pointMappers.yB;
	transitionLine("beta-data", data, x, "n", y, "b");
	transitionLine("beta-mx",   data, x, "n", y, "mxB");
	transitionLine("beta-z",    data, x, "n", y, "z");
	transitionLine("beta-mn",   data, x, "n", y, "mnB");

	x=pointMappers.x;
	y=pointMappers.yG;
	transitionLine("gamma-data",  data, x, "n", y, "g");
	transitionLine("gamma-mx",    data, x, "n", y, "mxG");
	transitionLine("gamma-z",     data, x, "n", y, "z");
	transitionLine("gamma-mn",    data, x, "n", y, "mnG");

	graph.selectAll('path.alpha').transition().duration(speed).attr("stroke-opacity", 1.0);
	graph.selectAll('circle.alpha').transition().duration(speed).attr("opacity", 1.0);
}
function switchToStats()
{
	$('#stats').show();
	$('#graphs').hide();
	if (chartData=="stats") return;
	chartData="stats";
}


function setStats(id1, id2, stats, v, alpha)
{
	if (v > stats.mx) { stats.mx=v; }
	if (v < stats.mn) { stats.mn=v; }
	stats.num++;
	stats.sum+=v;
	stats.ssum+=v*v;
	stats.asum+=Math.abs(v);
	stats.amx=Math.max(stats.mx, -1*stats.mn);
	$(id1 + ' div').text(Math.round(stats.amx));
	var ac=100;
	var av=(stats.sum/stats.num)
	var sd=Math.sqrt((stats.ssum/stats.num)-av*av);

	console.log("STATS("+id2+"): "+JSON.stringify(stats));

	$(".stats .min " + id2).text(stats.mn.toFixed(2));
	$(".stats .max " + id2).text(stats.mx.toFixed(2));
	$(".stats .avg " + id2).text(av.toFixed(2));
	$(".stats .sd " + id2).text(sd.toFixed(2));
	$(".stats .aavg " + id2).text((stats.asum/stats.num).toFixed(2));
}


function deviceOrientationListener(event) {
	 var alpha = (event.alpha > 180) ? event.alpha-360 : event.alpha;

     var count=data.length;
     var d = { a:alpha, b: event.beta, g:event.gamma, n: count };
     data.push(d);

     setStats("#gB", ".b", statsB, event.beta,  alpha);
     setStats("#gG", ".g", statsG, event.gamma, alpha);

}

function startListener() {
	console.log("START");
	sound.play();

	data = [];
	statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	chartType="linear";
	chartData="stats";

	$("#graphs").css("height", "690px")
	$("#graphs").css("width", "340px");
	$("#graphs svg").remove();

	graph = d3.select("#graphs").append("svg:svg")
		.attr("width", 340)
		.attr("height", 340)
		.append("svg:g");

	$('#stats').hide();
	$('#graphs').show();
	$('#buttons').hide();
	statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
	window.addEventListener("deviceorientation", deviceOrientationListener);
}

function stopListener() {
	console.log("STOP");
	$('#stats').show();
	$('#graphs').hide();
	$('#buttons').show();
	populateGraph(graph);

	sound.play();
	window.removeEventListener("deviceorientation", deviceOrientationListener);
}

function prepareListener()
{
	console.log("PREPARE");
	var s=1000;
	//s=100;
	window.setTimeout(
		function() { 
			startListener();
			window.setTimeout(function() { stopListener(); }, 10*s);
		}, 4*s);
	prepareListener();
}

$('#stats').hide();
$('#graph').show();
$('#buttons').hide();
$(document).ready(function() {
	sound = new Howl({ src: ["music/ting.wav"], volume: 1.0});
	
});

$('#switch-linear').click(switchToLinear);
$('#switch-polar').click(switchToPolar);
$('#switch-tilt').click(switchToTilt);
$('#switch-roll').click(switchToRoll);
$('#switch-stats').click(switchToStats);
$('#restart').click(startListener);
</script> 

	</body>
</html>
