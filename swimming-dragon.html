<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


		<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />-->
		<!--<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />-->
		<!--<link rel="stylesheet" href="css/nativedroid2.css" />-->
		<!--<link rel="stylesheet" href="vendor/waves/waves.min.css" />-->
		<!--<link rel="stylesheet" href="vendor/wow/animate.css" />-->
    	<link rel="stylesheet" type="text/css" href="css/swimming-dragon.css">
    	<link rel="stylesheet" type="text/css" href="css/table.css">

		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>
		<div>
			<div role="main">
				<div id="gB" class="graph-holder"><div></div></svg></div>
				<div id="gG" class="graph-holder"><div></div></svg></div>
				<div id="gA" class="graph-holder"><div></div></svg></div>
				<div id="xx" class="graph-holder"><div></div></div>
				<div>
					<table class="stats" id="hor-minimalist-b">
						<tr><th>Stats</th><th>Beta</th><th>Gamma</th></tr>
						<tr class="min"><th>Min</th><td class="b"></td><td class="g"></tr>
						<tr class="max"><th>Max</th><td class="b"></td><td class="g"></tr>
						<tr class="avg"><th>Avg</th><td class="b"></td><td class="g"></tr>
						<tr class="aavg"><th>Abs Avg</th><td class="b"></td><td class="g"></tr>
						<tr class="sd"><th>Std. Dev</th><td class="b"></td><td class="g"></tr>
					</table>
					<p>For a summary of beta and gamma, please look <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Orientation_and_motion_data_explained">here</a></p>
			</div>
		</div>
		<style>
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!--<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>-->
		<!--<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>-->
		<!--<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>-->
		<script src="https://d3js.org/d3.v3.min.js"></script>

		<script src="howler2.js"></script>
		<script src="NoSleep.js"></script>

		<script>
    $(document).bind('mobileinit',function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });

function popCircle(graph, label, data, range, showLine, showAxis)
{
	var m = [0, 5, 15, 5]; // margins
	if (range == null)
	{
		var mx = Math.max.apply(null, data);
		var mn = Math.min.apply(null, data);
		range = Math.max(mx, -1*mn)*1.1;
		m = [0, 5, 0, 5];
	}

	// define dimensions of graph
	
	var w = 340 - m[1] - m[3];	// width
	var h = 340 - m[0] - m[2]; // height

	var x   = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
	var y   = d3.scale.linear().domain([ -1*range,  range]).range([h, 0]); 
	

	var cX=function(d) { 
		r=((d.b+range)/(2*range)) * 20 + 20;
		t=d.a/360*Math.PI;
		return Math.cos(t) * r + 60;}

	var cY=function(d) { 
		r=((d.b+range)/(2*range)) * 20 + 20;
		t=d.a/360*Math.PI;
		return Math.sin(t) * r + 60;}
	var d3l = d3.svg.line()
		.x(cX)
		.y(cY);

	var graph = d3.select(graph).append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

	graph.append("svg:path").attr("d", d3l(data)).attr("class", label);

}

function populateGraph(graph, label, data, range, showLine, showAxis)
{	
		var m = [0, 5, 15, 5]; // margins
		if (range == null)
		{
			var mx = Math.max.apply(null, data);
			var mn = Math.min.apply(null, data);
			range = Math.max(mx, -1*mn)*1.1;
			m = [0, 5, 0, 5];
		}

		// define dimensions of graph
		
		var w = 340 - m[1] - m[3];	// width
		var h = 90 - m[0] - m[2]; // height

		var x   = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
		var y   = d3.scale.linear().domain([ -1*range,  range]).range([h, 0]); 
		var d3l = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d)   { return y(d); });
		
		
		// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select(graph).append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

		if (showAxis)
		{
			var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
			graph.append("svg:g")
			      .attr("class", "x axis")
			      .attr("transform", "translate(0," + h + ")")
			      .call(xAxis);
		}


		if (showLine)
			graph.append("svg:path").attr("d", d3l(data)).attr("class", label);
		else
			graph.selectAll("dot")
	        	.data(data)
	      		.enter().append("circle")
	      	        .attr("r", 0.7)
	        		.attr("cx", function(d, i) { return x(i); })
	       			.attr("cy", function(d) { return y(d); });


		
}

var date = new Date();
var start = 0;
var data = [];
var dataA = [];
var dataB = [];
var dataG = [];
var maxB = { v: 0, d: null };
var maxG = { v: 0, d: null };

var statsB = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var statsG = { num: 0, asum:0, sum:0, ssum:0, mx: -10000, amx: -10000, mn: 10000 };
var sound = new Audio("music/ting.wav");

function setStats(id1, id2, stats, v, alpha)
{
	if (v > stats.mx) { stats.mx=v; }
	if (v < stats.mn) { stats.mn=v; }
	stats.num++;
	stats.sum+=v;
	stats.ssum+=v*v;
	stats.asum+=Math.abs(v);
	stats.amx=Math.max(stats.mx, -1*stats.mn);
	$(id1 + ' div').text(Math.round(stats.amx));
	var ac=100;
	var av=(stats.sum/stats.num)
	var sd=Math.sqrt((stats.ssum/stats.num)-av*av);

	$(".stats .min " + id2).text(Math.round(stats.mn*ac)/ac);
	$(".stats .max " + id2).text(Math.round(stats.mx*ac)/ac);
	$(".stats .avg " + id2).text(Math.round(av*ac)/ac);
	$(".stats .sd " + id2).text(Math.round(sd*ac)/ac);
	$(".stats .aavg " + id2).text(Math.round(stats.asum/stats.num*ac)/ac);
}


function deviceOrientationListener(event) {
	 var alpha = (event.alpha > 180) ? event.alpha-360 : event.alpha;
     dataA.push(alpha);
     dataB.push(event.beta);
     dataG.push(event.gamma);

     var count=data.length;
     var d = { a:alpha, b: event.beta, g:event.gamma, n: count };
     data.push(d);

     setStats("#gB", ".b", statsB, event.beta,  alpha);
     setStats("#gG", ".g", statsG, event.gamma, alpha);

}

function startListener() {
	//console.log("START");
	sound.play();
	dataA = [];
	dataB = [];
	dataG = [];
	maxB = { v: -1, d: null };
	maxG = { v: -1, d: null };
	maxA = { v: 0, d: null };
	window.addEventListener("deviceorientation", deviceOrientationListener);
}

function stopListener() {
	//console.log("STOP");
	sound.play();
	window.removeEventListener("deviceorientation", deviceOrientationListener);
    populateGraph("#gB", "dataB", dataB, null, true,  true);
    populateGraph("#gG", "dataG", dataG, null, true,  true);
    populateGraph("#gA", "dataA", dataA, 180, false, true);
    popCircle("#xx", "dataA", data, null, true, true);
}

$(document).ready(function() {
	//console.log("INIT");	
	sound = new Howl({ src: ["music/ting.wav"], volume: 1.0});
	
	var s=1000;
	s=100;
	window.setTimeout(
		function() { 
			$('.ui-content').css('background-color', 'white');
			startListener();
			window.setTimeout(function() { stopListener(); }, 30*s);
		}, 4*s);
});
</script> 

	</body>
</html>
